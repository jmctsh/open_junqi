# 军棋 AI 桌面版

一个可视化的军棋对战与演示程序，支持四方（南/西/北/东）对战、铁路规则、行营/大本营、即时淘汰等核心机制。

## 安装与运行

- 依赖安装：
  - Python 3.10+
  - `pip install -r requirements.txt`
- 启动程序：
  - **启动桌面程序**：`python main.py`
  - **启动服务器**：`python server/game_server.py`

## 基本用法

- 布局阶段：四方自动布阵完成后可开始对局；支持在己方区域拖拽交换棋子位置（遵守单位限制：地雷必须在后两排、军旗必须在大本营等）。
- 对局阶段：按回合逆时针轮转；点击己方可动棋子，再点击合法目的地完成移动与战斗；跳过与投降按钮位于右下角。
- 即时淘汰：
  - 当玩家军旗被消灭，或该玩家"没有任何可移动的子"（例如只剩地雷/军旗、大本营中的子、或通路被己方不可动子封死），系统会立即判定其死亡，并清除其所有棋子。
  - 当同轴队（南+北 或 东+西）同时阵亡时，棋局立即结束。

## AI 代理与多人联机

- **智能代理**：接入豆包/ARK API，支持多个 AI 玩家自主决策并语音解说，具备角色扮演和战术分析能力。
- **联机服务器**：基于 WebSocket 协议，支持实时对战、广播消息与语音合成。

### 环境配置（服务器模式）

请参考仓库根目录的 `.env.example`，按注释提示复制为 `.env` 并填写各玩家的 ARK API 与 TTS 凭据即可。

### 广播消息结构

服务器向客户端广播的消息包含以下核心字段：

- `type`：消息类型（如 `piece_moved`、`game_state_changed` 等）
- `player_id`：当前操作玩家 ID
- `game_state`：包含 `current_player_faction`、`faction_names` 等游戏状态
- `utterance`：AI 语音解说文本
- `utterance_tts_base64`：TTS 合成的音频数据（Base64 编码）
- `utterance_target`：发言目标（指向特定阵营）
- `selected_id`：AI 选择的候选动作 ID
- `protocol_version`：协议版本

## 战绩标记（升星）

- 累计击杀数：每个棋子都记录自身的 `击杀数`（kill_count）。战斗时，胜者会继承败者的战绩并再加 1：
  - 攻击方胜利：攻击方 `kill_count += 防守方.kill_count + 1`。
  - 防守方胜利：防守方 `kill_count += 攻击方.kill_count + 1`。
- 显示规则：在棋子右下角绘制战绩标记（洋红色），随棋子移动；棋子死亡则不显示。
  - 1/2 杀：显示"^"形标记（较小号、细线）。
  - 3 杀及以上：显示小五角星（整体缩小一号，贴近右下角）。

## 自定义标记（面向棋子）

- 右键已有棋子弹出标记菜单，可为该棋子设置一个简短标记，例如：`司、军、师、旅、团、营、连、排、工、炸、雷、旗`，或选择"清除"删除标记。
- 标记会跟随棋子移动；当棋子死亡时，其标记会自动清除。
- 标记显示位置：在格子的左上角以小号文字显示；同时棋子未知标识"?"不会与标记重叠显示。

## 许可证

本作品采用知识共享署名-非商业性使用 4.0 国际许可协议（CC BY-NC 4.0）进行许可。

您可以自由地复制、分发、展示和演绎本作品，但必须遵守以下条件：
- 署名（BY）：您必须适当署名，注明原作者，并提供本许可证的链接。
- 非商业性使用（NC）：您不得将本作品用于任何商业目的，包括但不限于：
  1. 以盈利为目的的直播活动（如带货直播、付费直播等）
  2. 用于商业性质的视频制作（如广告视频、付费课程视频、企业宣传视频等）
  3. 其他任何形式的商业盈利行为

完整许可文本请参见：https://creativecommons.org/licenses/by-nc/4.0/legalcode

## 贡献与派生使用（Fork）

- 欢迎 Fork 本仓库用于学习、研究与非商业交流。
- 在 Fork 基础上进行修改、增加功能、二次开发是允许的，但必须遵守 CC BY-NC 4.0：保留署名、提供许可证链接、不得用于任何商业目的。
- 发布派生版本时，请在 README 中注明来源链接与原作者；保留本仓库的许可证段落或以醒目位置链接至完整许可文本。
- 欢迎通过 Pull Request 贡献改进；提交前请确保不包含任何敏感凭据或密钥。
- 若用于公开演示/教学，请附上协议与来源说明。